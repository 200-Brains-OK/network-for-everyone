# 6장 전송계층: 신뢰할 수 있는 데이터 전송하기

## 전송 계층의 역할

데이터가 전송될 때 손상되거나 유실될 수 있음  
목적지에 신뢰할 수 있는 데이터를 전달하기 위한 계층

- 오류를 점검하는 기능 → 데이터를 재전송하도록 요청  
- 전송된 데이터의 목적지가 어떤 어플리케이션인지 식별하는 기능

**연결형 통신 / 비연결형 통신**

전송 계층의 특징? 신뢰성 / 정확성 / 효율성

- 신뢰성과 정확성: 연결형 통신 (TCP)
- 효율적: 비연결형 통신 (UDP)

연결형 통신은 상대편과 확인해 가면서 통신하는 방식  
비연결형 통신은 상대편을 확인하지 않고 일방적으로 데이터를 전송하는 방식  

동영상 (빠른 전송이 필요하다)

## TCP

신뢰할 수 있는 정확한 연결형 통신  
TCP 캡슐화  

TCP 헤더를 붙인다.  
이를 **세그먼트**라고 한다.

### 코드 비트

| URG | ACK(확인응답) | PSH | RST | SYN(연결) | FIN(제거) |
| --- | --- | --- | --- | --- | --- |
| 0 | 0 | 0 | 0 | 0 | 0 |
| 1비트 | 1비트 | 1비트 | 1비트 | 1비트 | 1비트 |

## 3-way 핸드셰이크

**연결(connection) 확립**  
TCP 통신에서 정보를 전달하기 위해 사용되는 가상의 통신로  
연결을 확립하고 데이터를 전송한다.

**컴퓨터 1**                                       **컴퓨터 2**

1. 연결 요청  
   `syn 1 →`

2. 연결 확립 응답 + 연결 요청  
   `← ack 1 syn 1`

3. 연결 확립 응답  
   `ack 1 →`

3번의 확인이 있기 때문에 **3-way 핸드셰이크**라고 한다.  
또한 양방향으로 연결을 하기 때문에 각각의 컴퓨터에서 요청과 응답이 1번씩 이루어져야 한다.

**연결 해제**

**컴퓨터 1**                                       **컴퓨터 2**

1. `fin 요청`  
   `fin 1 →`

2. `ack 승인`  
   `← ack 1`

3. `fin 요청`  
   `← fin 1`

4. `ack 승인`  
   `ack 1 →`

마찬가지로 각각의 컴퓨터에서 `fin`과 `ack`가 각각 한 번씩 이루어진다.  
**3way**와 **4way** 차이가 나는 이유는 처음 연결을 시도할 때는 단방향 연결이지만, 연결이 이루어지고 난 이후에는 양방향 연결이기 때문이다.  
`fin`을 요청받은 쪽에서 아직 전송해야 할 데이터가 남아 있을 수도 있기 때문에, `ack`을 보내고 전송이 다 끝난 게 확실해지면 그때 다시 `fin`을 보내야 한다.

## 일련번호와 확인 응답 번호의 구조

3-way 핸드셰이크 이후 실제 데이터 전송에 사용되는 TCP 헤더의 일련번호와 확인응답 번호  
TCP는 데이터를 분할해서 보내기 때문에 일련번호를 통해 데이터의 순서를 확인한다.  
확인응답 번호는 수신 측이 몇 번째 데이터를 수신했는지 송신 측에 알려주는 역할을 한다.  
또한 다음 번호의 데이터를 요청하는 데에도 사용된다.

### 재전송 제어

**송신**

- 3001 4001  
  내가 보낼 데이터, 확인 응답 코드 (전송 확인용)

**수신**

- 4001 3201  
  확인 응답 코드, 다음에 수신하고자 하는 번호 (수신 요청)

**송신**

- 3201 4001  
  수신 요청받은 데이터, 확인 응답 코드

**수신**

- 4001 3401  
  확인 응답 코드, 다음에 수신하고자 하는 번호 (수신 요청)

### 윈도우 제어

송/수신이 데이터 전송 한 번마다 이루어지는 것이 아니라 여러 번 연속으로 처리하는 방식  
수신 측은 송신받은 데이터들을 버퍼에 가능한 만큼 저장한 후 한 번에 응답한다.  
버퍼 오버플로우를 피하기 위해 윈도우 크기를 알아야 하는데, 이는 연결 확립 과정에서 알게 된다.

## 포트 번호

전송된 데이터의 목적지가 어느 어플리케이션인지 구분한다.  
포트 번호는 0 ~ 65535번을 사용한다.

- **Well Known Port** - 주요 프로토콜이 사용하는 포트 번호로 0 ~ 1023번까지이다.
- 1025번 이상은 랜덤 포트로 클라이언트 측의 송신 포트로 사용됨.

| 애플리케이션 | 포트 번호 |
| --- | --- |
| SSH | 22 |
| SMTP | 25 |
| DNS | 53 |
| HTTP | 80 |
| POP3 | 110 |
| HTTPS | 443 |

서버 측에서는 포트 번호를 정해 둬야 하지만, 클라이언트 측은 임의의 포트가 자동으로 할당되기 때문에 미리 정해 두지 않아도 괜찮다.

## UDP의 구조

TCP와 달리 효율성을 중요하게 여기는 프로토콜로 확인하는 과정이 없다.

### 장점
- 데이터를 효율적으로 빠르게 보내는 것

### UDP 헤더

| 출발지 포트 번호 | 목적지 포트 번호 |
| --- | --- |
| 길이 | 체크섬 |

### UDP 데이터그램

| UDP 헤더 | 데이터 |
| --- | --- |

**브로드캐스트** - LAN에 있는 컴퓨터와 네트워크 장비에 데이터를 일괄로 보낼 수 있다.
